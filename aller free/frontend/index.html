<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Aller Free </title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Estilos espec√≠ficos para a listagem de produtos */
        #filtros-container {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ddd;
        }
        #tags-filtro {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        #tags-filtro label {
            background-color: #fff;
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #tags-filtro input[type="checkbox"] {
            display: none; /* Esconde o checkbox padr√£o */
        }
        #tags-filtro input[type="checkbox"]:checked + label {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
            font-weight: bold;
        }

        #produtos-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .produto-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            background: white;
            transition: transform 0.1s;
        }
        .produto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .produto-card h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        .produto-card .preco {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin: 5px 0;
        }
        .produto-tags {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }
        .produto-tags .tag-label {
            display: inline-block;
            background: #e0f7e0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .btn-carrinho {
            background-color: #ff9800;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="geral">
        <div id="cabecalho">
            <h1> Aller Free </h1>
            <p id="auth-status" style="font-size: 0.9em; margin: 5px 0;">
                <a href="login/login.html">Fazer Login</a>
            </p>
            <p style="margin: 5px 0;"><a href="produtos/carrinho.html" style="font-weight: bold;">[ üõí Carrinho ]</a></p>
        </div>

        <div id="barra_pesquisa">
            <input type="search" id="search-input" placeholder="Buscar lojas ou produtos...">
        </div>
        
        <div id="filtros-container">
            <h2>Filtros (Restri√ß√µes)</h2>
            <div id="tags-filtro">
                Carregando tags...
            </div>
        </div>

        <div id="conteudo">
            <h2>Produtos Pr√≥ximos</h2>
            
            <div id="mapa-e-produtos">
                <div class="mapa-placeholder">
                    Mapa vai aqui
                </div>

                <div id="produtos-lista">
                    <p id="loading-message">Carregando produtos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        const tagsFiltroContainer = document.getElementById('tags-filtro');
        const produtosListaContainer = document.getElementById('produtos-lista');
        const searchInput = document.getElementById('search-input');
        const loadingMessage = document.getElementById('loading-message');
        const authStatus = document.getElementById('auth-status');

        let allProducts = [];
        let allTags = [];
        let selectedTagCodes = [];

        // ----------------- Utilit√°rios -----------------
        function decodeToken(jwtToken) {
            try {
                if (!jwtToken) return null;
                // Simplesmente decodifica o payload (parte do meio)
                const payload = jwtToken.split('.')[1];
                // Necess√°rio padding em alguns casos de base64
                const base64 = payload.replace(/-/g, '+').replace(/_/g, '/');
                const padding = base64.length % 4;
                const paddedBase64 = base64 + '='.repeat(padding > 0 ? 4 - padding : 0);
                
                return JSON.parse(atob(paddedBase64));
            } catch (e) {
                return null;
            }
        }
        
        // ----------------- Autentica√ß√£o e Navega√ß√£o -----------------
        function updateAuthStatus() {
            const token = localStorage.getItem('accessToken');
            const userPayload = decodeToken(token);
            let statusHtml = '';

            if (userPayload) {
                const role = userPayload.role;
                let profileLink = 'perfis/client_profile.html';
                let dashboardLink = '';

                if (role === 'merchant') {
                    profileLink = 'merchant_profile.html';
                    dashboardLink = ` | <a href="perfis/merchant_profile.html" style="font-weight: bold;">Dashboard Lojista</a>`;
                } else if (role === 'admin') {
                    profileLink = 'admin_dashboard.html';
                    dashboardLink = ` | <a href="dashboard/admin_dashboard.html" style="font-weight: bold; color: #007bff;">Painel Admin</a>`;
                }
                
                // Exibe Status + Link de Perfil + Dashboard/Fun√ß√£o
                statusHtml = `
                    Logado (${role}). 
                    | <a href="${profileLink}">Meu Perfil</a>
                    ${dashboardLink}
                    | <a href="#" onclick="logout()">Sair</a>
                `;
            } else {
                statusHtml = '<a href="login/login.html">Fazer Login</a> | <a href="cadastros/register.html">Cadastrar</a>';
            }

            authStatus.innerHTML = statusHtml;
        }

        function logout() {
            localStorage.removeItem('accessToken');
            updateAuthStatus();
            alert('Sess√£o encerrada.');
            window.location.reload(); 
        }

        // ----------------- Tags e Filtros -----------------
        async function fetchTags() {
            try {
                const response = await fetch(`${API_URL}/tags/all`);
                if (!response.ok) throw new Error('Falha ao carregar tags.');
                allTags = await response.json();
                renderTagsFilter();
            } catch (error) {
                tagsFiltroContainer.innerHTML = `<p style="color: red;">Erro ao carregar tags: ${error.message}</p>`;
                console.error(error);
            }
        }

        function renderTagsFilter() {
            tagsFiltroContainer.innerHTML = '';
            allTags.forEach(tag => {
                const inputId = `filter-tag-${tag.code}`;
                tagsFiltroContainer.innerHTML += `
                    <input type="checkbox" id="${inputId}" value="${tag.code}" onchange="filterProducts()">
                    <label for="${inputId}">${tag.label}</label>
                `;
            });
        }

        function collectSelectedTags() {
            return Array.from(document.querySelectorAll('#tags-filtro input[type="checkbox"]:checked'))
                        .map(checkbox => checkbox.value);
        }
        
        // ----------------- Produtos -----------------
        async function fetchProducts() {
            loadingMessage.style.display = 'block';
            produtosListaContainer.innerHTML = '';
            try {
                // Assumindo um endpoint que lista todos os produtos, conforme schemas.py (ProductOut)
                const response = await fetch(`${API_URL}/produtos/all`);
                if (!response.ok) throw new Error('Falha ao carregar produtos.');
                
                // Simula√ß√£o: A resposta deve ser uma lista de ProductOut
                allProducts = await response.json(); 
                
                // Simula√ß√£o de dados se o backend n√£o estiver rodando:
                // allProducts = [
                //     { id: 1, name: 'Bolo de Cenoura Sem Gl√∫ten', description: 'Feito com farinha de arroz.', price: 15.00, active: true, tags: [{ code: 'gluten_free', label: 'Sem Gl√∫ten' }] },
                //     { id: 2, name: 'Torta Vegana de Lim√£o', description: 'Sem ovos e sem lactose.', price: 25.50, active: true, tags: [{ code: 'vegan', label: 'Vegano' }, { code: 'lactose_free', label: 'Sem Lactose' }] },
                //     { id: 3, name: 'P√£o Integral Artesanal', description: 'Cont√©m gl√∫ten.', price: 10.00, active: true, tags: [] }
                // ];

                filterProducts();
            } catch (error) {
                loadingMessage.textContent = 'N√£o foi poss√≠vel carregar os produtos. Verifique se o backend est√° rodando em ' + API_URL;
                loadingMessage.style.color = 'red';
                console.error(error);
            }
        }

        function filterProducts() {
            const selectedTags = collectSelectedTags();
            const searchTerm = searchInput.value.toLowerCase();

            const filteredProducts = allProducts.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                      (product.description && product.description.toLowerCase().includes(searchTerm));
                
                if (!matchesSearch) return false;

                // Se nenhuma tag for selecionada, exibe todos os produtos que passaram na busca.
                if (selectedTags.length === 0) return true;

                // Um produto √© exibido apenas se ele CONTIVER TODAS as tags selecionadas.
                const productTagCodes = product.tags.map(tag => tag.code);
                return selectedTags.every(selectedCode => productTagCodes.includes(selectedCode));
            });

            renderProducts(filteredProducts);
        }

        function renderProducts(products) {
            produtosListaContainer.innerHTML = '';
            loadingMessage.style.display = 'none';

            if (products.length === 0) {
                produtosListaContainer.innerHTML = '<p>Nenhum produto encontrado com os filtros e busca selecionados.</p>';
                return;
            }

            products.forEach(product => {
                const tagsHtml = product.tags.map(tag => 
                    `<span class="tag-label">${tag.label}</span>`
                ).join('');

                produtosListaContainer.innerHTML += `
                    <div class="produto-card">
                        <h3>${product.name}</h3>
                        <p>${product.description || 'Sem descri√ß√£o.'}</p>
                        <p class="preco">R$ ${product.price.toFixed(2)}</p>
                        <div class="produto-tags">Tags: ${tagsHtml || 'Nenhuma'}</div>
                        <button class="btn-carrinho" onclick="addToCart(${product.id})"> Adicionar ao Carrinho </button>
                    </div>
                `;
            });
        }

        // Fun√ß√£o de adicionar ao carrinho em index.html
function addToCart(product) { // A fun√ß√£o deve receber o objeto produto, n√£o apenas o ID
    let cart = JSON.parse(localStorage.getItem('allerFreeCart') || '[]');
    const existingItemIndex = cart.findIndex(item => item.id === product.id);

    if (existingItemIndex > -1) {
        cart[existingItemIndex].quantity += 1;
    } else {
        cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            tags: product.tags,
            quantity: 1
        });
    }

    localStorage.setItem('allerFreeCart', JSON.stringify(cart));
    alert(`"${product.name}" adicionado ao carrinho!`);
}

// Onde o produto √© renderizado, chame a fun√ß√£o passando o objeto:
// Modifique a chamada dentro do forEach do renderProducts(products):
/*
<button class="btn-carrinho" onclick='addToCart(${JSON.stringify(product)})'> Adicionar ao Carrinho </button>
*/
        
        // ----------------- Inicializa√ß√£o -----------------
        updateAuthStatus();
        fetchTags();
        fetchProducts();
        
        // Adiciona listeners para filtrar em tempo real
        searchInput.addEventListener('input', filterProducts);
    </script>
</body>
</html>